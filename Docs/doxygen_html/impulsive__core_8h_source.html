<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>My Project: E:/_PhD/00_PST_CURRENT/impulsive_core.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">E:/_PhD/00_PST_CURRENT/impulsive_core.h</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#define BOND_ANGLE_DISTRIBUTION_NONE 0</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#define BOND_ANGLE_DISTRIBUTION_GROUND 1</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#define BOND_ANGLE_DISTRIBUTION_PARENT 2</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">//***********************************************************************************************************************************************************************************</span></div>
<div class="line"><a name="l00005"></a><span class="lineno"><a class="line" href="class_impulsive___phasespace___core.html">    5</a></span>&#160;<span class="keyword">class </span><a class="code" href="class_impulsive___phasespace___core.html">Impulsive_Phasespace_Core</a> : <span class="keyword">public</span> <a class="code" href="class_phasespace___core.html">Phasespace_Core</a></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;{</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    <span class="keyword">public</span>:</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_impulsive___core___input.html">Impulsive_Core_Input</a> *i_input_data; <span class="comment">//these are additional pointers to the Core_Input and Fragment objects pointed to by the pointers in the base class</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a> *i_parent, *i_frag1, *i_frag2; <span class="comment">//however, these pointers are dynamically cast to be the derived class pointers so the extra functionality is accessible</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        <span class="keywordtype">double</span> E_recoil, tunneling_probability;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        std::vector&lt;Impulsive_Bond_Angle_Distribution_Element&gt; bond_angle_distribution;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;        <span class="keyword">virtual</span> ~<a class="code" href="class_impulsive___phasespace___core.html">Impulsive_Phasespace_Core</a>();</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        <a class="code" href="class_impulsive___phasespace___core.html">Impulsive_Phasespace_Core</a>(){};</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        <a class="code" href="class_impulsive___phasespace___core.html">Impulsive_Phasespace_Core</a>(<span class="keyword">const</span> <a class="code" href="class_impulsive___core___input.html">Impulsive_Core_Input</a> *in_input_data, <span class="keyword">const</span> <a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a> *in_parent, <span class="keyword">const</span> <a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a> *in_frag1, <span class="keyword">const</span> <a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a> *in_frag2, <a class="code" href="class_phasespace___result.html">Phasespace_Result</a> *in_output_data);</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="class_impulsive___phasespace___core.html#a3ebf889009436ee732ae617225e83677">create_input_pointer</a>();</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="class_impulsive___phasespace___core.html#a4ce4fe5e7ba2c7c9785b865aea84af7e">create_fragment_pointers</a>();</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="class_impulsive___phasespace___core.html#a27da2cd40c7a33e15bdca0caa8bddbf7">initialise</a>();</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;        <span class="keywordtype">double</span> Eckart();</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;        <span class="keyword">virtual</span> <span class="keywordtype">void</span> run();</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;        <span class="keyword">virtual</span> <span class="keywordtype">void</span> process_state(<span class="keyword">const</span> <a class="code" href="struct_double___quantum___state.html">Double_Quantum_State</a> &amp;state);</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        <span class="keywordtype">void</span> apply_impulse(<span class="keyword">const</span> <a class="code" href="struct_double___quantum___state.html">Double_Quantum_State</a> &amp;state, <a class="code" href="struct_double___quantum___state.html">Double_Quantum_State</a> &amp;state_with_impulse, <span class="keywordtype">double</span> &amp;E_wrongBy, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> &amp;i);</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;};</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;Impulsive_Phasespace_Core::~Impulsive_Phasespace_Core() {</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;}</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;Impulsive_Phasespace_Core::Impulsive_Phasespace_Core(<span class="keyword">const</span> <a class="code" href="class_impulsive___core___input.html">Impulsive_Core_Input</a> *in_input_data, <span class="keyword">const</span> <a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a> *in_parent, <span class="keyword">const</span> <a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a> *in_frag1, <span class="keyword">const</span> <a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a> *in_frag2, <a class="code" href="class_phasespace___result.html">Phasespace_Result</a> *in_output_data){</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    copy_pointers(in_input_data, in_parent, in_frag1, in_frag2, in_output_data);</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <a class="code" href="class_impulsive___phasespace___core.html#a3ebf889009436ee732ae617225e83677">create_input_pointer</a>();</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    <a class="code" href="class_impulsive___phasespace___core.html#a4ce4fe5e7ba2c7c9785b865aea84af7e">create_fragment_pointers</a>();</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    <a class="code" href="class_impulsive___phasespace___core.html#a27da2cd40c7a33e15bdca0caa8bddbf7">initialise</a>();</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    run();</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;}</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="class_impulsive___phasespace___core.html#a3ebf889009436ee732ae617225e83677">   36</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_impulsive___phasespace___core.html#a3ebf889009436ee732ae617225e83677">Impulsive_Phasespace_Core::create_input_pointer</a>(){</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    i_input_data = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_impulsive___core___input.html">Impulsive_Core_Input</a>*<span class="keyword">&gt;</span>(input_data); </div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;}</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00040"></a><span class="lineno"><a class="line" href="class_impulsive___phasespace___core.html#a4ce4fe5e7ba2c7c9785b865aea84af7e">   40</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_impulsive___phasespace___core.html#a4ce4fe5e7ba2c7c9785b865aea84af7e">Impulsive_Phasespace_Core::create_fragment_pointers</a>(){</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    i_parent = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a>*<span class="keyword">&gt;</span>(<a class="code" href="class_phasespace___core.html#a2f0204f1c0441f1b874c28df78462f66">parent</a>); </div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    i_frag1 = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a>*<span class="keyword">&gt;</span>(frag1);</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    i_frag2 = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="class_impulsive___molecule.html">Impulsive_Molecule</a>*<span class="keyword">&gt;</span>(frag2);</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;}</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00046"></a><span class="lineno"><a class="line" href="class_impulsive___phasespace___core.html#a27da2cd40c7a33e15bdca0caa8bddbf7">   46</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_impulsive___phasespace___core.html#a27da2cd40c7a33e15bdca0caa8bddbf7">Impulsive_Phasespace_Core::initialise</a>(){</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <a class="code" href="class_phasespace___core.html#ab892790f7c9d9584f388ddd85df21489">Phasespace_Core::initialise</a>();</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <a class="code" href="class_impulsive___bond___angle___distribution___element.html">Impulsive_Bond_Angle_Distribution_Element</a> temp_angle_distribution_element;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    std::vector&lt;Impulsive_Bond_Angle_Distribution_Element&gt; compressed_bond_angle_distribution;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keywordtype">unsigned</span> i, j;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="keywordtype">bool</span> element_found;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="keywordtype">double</span> reduced_mass_kg, f1_i_param_m, f2_i_param_m, f1_m_inertia_kgsqm, f2_m_inertia_kgsqm, f1_x, f2_x, E_iTrans;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keywordflow">if</span> (i_parent-&gt;use_angle_distribution) bond_angle_distribution=i_input_data-&gt;bond_angle_distribution; <span class="comment">//first, copy the bond angle distribution (or create single element version if not passing a distribution)</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordflow">else</span>{<span class="comment">//just use equilibrium angle with 100% probability for single element option</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        temp_angle_distribution_element.probability=1;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        temp_angle_distribution_element.f1_radians=i_parent-&gt;TS_frag1_equilibrium_angle;<span class="comment">//*RAD_IN_DEGREE; //default is 0 (if no barrier, impulsive_rotation_factor will not matter because multiplied by 0 barrier)</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        temp_angle_distribution_element.f2_radians=i_parent-&gt;TS_frag2_equilibrium_angle;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        temp_angle_distribution_element.f1_mo_inertia=i_parent-&gt;TS_frag1_moment_of_inertia;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        temp_angle_distribution_element.f2_mo_inertia=i_parent-&gt;TS_frag2_moment_of_inertia;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        bond_angle_distribution.push_back(temp_angle_distribution_element);</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    }<span class="comment">// then, work out tunneling probability and recoil energy</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="keywordflow">if</span> (i_input_data-&gt;E_available &lt;= 0) { <span class="comment">//if not enough energy to get over barrier (we may want to be more robust here and ensure E_total&gt;=E_dissociation, although should be eliminated in caller hopefully)</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="keywordflow">if</span> (i_input_data-&gt;tunneling_model==0) tunneling_probability=0; <span class="comment">//no tunneling</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i_input_data-&gt;tunneling_model==1) tunneling_probability=Eckart(); <span class="comment">//use the Eckart tunneling model</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        E_recoil=i_input_data-&gt;E_total-i_parent-&gt;E_dissociation; <span class="comment">//recoil energy is energy over dissociation energy</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    }<span class="keywordflow">else</span> {<span class="comment">//there is enough energy to get over barrier, no tunneling required</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        tunneling_probability=1;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        E_recoil=i_parent-&gt;E_barrier;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    }<span class="comment">// next, calculate E_rot for f1 and f2 at each bond angle (the bond angle distro is really only relevent for triatomic parents, and is therefore undocumanted. Future versions will account for all normal modes of TS and use metropolis sampling to describe how those modes change the bond angle and moment of inertia)</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="keywordflow">if</span> (i_parent-&gt;E_barrier){ <span class="comment">//this if added because otherwise if no barrier, no TS, no i_parent-&gt;TS_moment_of_inertia, so impulsive_rotation_factor will become nan if this calculation occurs (impulsive_rotation_factor should just stay default of 0 if no barrier)</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        reduced_mass_kg=get_reduced_mass(i_frag1-&gt;mass, i_frag2-&gt;mass)*KG_IN_AMU;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        <span class="comment">//persistent_output&lt;&lt;&quot;*** full distro ***&quot;&lt;&lt;endl;</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        <span class="keywordflow">if</span> (i_input_data-&gt;output_to_file){</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;            <span class="keywordflow">if</span> (!i_frag1-&gt;single_atom) fprintf(out_file.fp, <span class="stringliteral">&quot;\n*** Impulsive Parameters Fragment 1 ***\nTS_frag1_equilibrium_angle=%lf\nTS_frag1_pivot_to_com_length=%lf\nTS_frag1_moment_of_inertia=%lf\nTS_frag1_kn_ratio=%lf\n&quot;</span>,</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                    i_parent-&gt;TS_frag1_equilibrium_angle, i_parent-&gt;TS_frag1_pivot_to_com_length, i_parent-&gt;TS_frag1_moment_of_inertia, i_parent-&gt;TS_frag1_kn_ratio);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;            <span class="keywordflow">if</span> (!i_frag2-&gt;single_atom) fprintf(out_file.fp, <span class="stringliteral">&quot;\n*** Impulsive Parameters Fragment 2 ***\nTS_frag2_equilibrium_angle=%lf\nTS_frag2_pivot_to_com_length=%lf\nTS_frag2_moment_of_inertia=%lf\nTS_frag2_kn_ratio=%lf\n&quot;</span>,</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                    i_parent-&gt;TS_frag2_equilibrium_angle, i_parent-&gt;TS_frag2_pivot_to_com_length, i_parent-&gt;TS_frag2_moment_of_inertia, i_parent-&gt;TS_frag2_kn_ratio);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            fprintf(out_file.fp, <span class="stringliteral">&quot;\n*** Impulsive Angle Distribution ***\n radians, probability, fragment, i_n, i_k, i_E_nk\n&quot;</span>);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        }</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <span class="keywordflow">for</span> (i=0; i&lt;bond_angle_distribution.size(); i++){</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;            f1_x=f2_x=0;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            <span class="keywordflow">if</span> (!i_frag1-&gt;single_atom){</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                f1_m_inertia_kgsqm=bond_angle_distribution[i].f1_mo_inertia*KG_SQM_IN_AMU_SQA;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                f1_i_param_m=i_parent-&gt;TS_frag1_pivot_to_com_length*sin(bond_angle_distribution[i].f1_radians)*METERS_IN_ANGSTROM;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                f1_x=pow(f1_i_param_m,2)*reduced_mass_kg/f1_m_inertia_kgsqm;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            }</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;            <span class="keywordflow">if</span> (!frag2-&gt;single_atom){</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                f2_m_inertia_kgsqm=bond_angle_distribution[i].f2_mo_inertia*KG_SQM_IN_AMU_SQA;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                f2_i_param_m=i_parent-&gt;TS_frag2_pivot_to_com_length*sin(bond_angle_distribution[i].f2_radians)*METERS_IN_ANGSTROM;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                f2_x=pow(f2_i_param_m,2)*reduced_mass_kg/f2_m_inertia_kgsqm;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            }</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;            E_iTrans=E_recoil/(1+f1_x+f2_x);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            <span class="keywordflow">if</span> (!i_frag1-&gt;single_atom){</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                i_frag1-&gt;<a class="code" href="class_impulsive___molecule.html#aac407e174c14432636ced91f96051ad7">get_impulse_nk</a>(E_iTrans*f1_x, i_parent-&gt;TS_frag1_kn_ratio, bond_angle_distribution[i].f1_n_imp, bond_angle_distribution[i].f1_k_imp, bond_angle_distribution[i].f1_E_nk_imp);</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                <span class="keywordflow">if</span> (i_input_data-&gt;output_to_file) fprintf(out_file.fp, <span class="stringliteral">&quot;%lf, %lf, 1, %u, %u, %lf\n&quot;</span>,</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                                                          bond_angle_distribution[i].f1_radians, bond_angle_distribution[i].probability,</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                                                          bond_angle_distribution[i].f1_n_imp, bond_angle_distribution[i].f1_k_imp, bond_angle_distribution[i].f1_E_nk_imp);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            }</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            <span class="keywordflow">if</span> (!i_frag2-&gt;single_atom){</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                i_frag2-&gt;<a class="code" href="class_impulsive___molecule.html#aac407e174c14432636ced91f96051ad7">get_impulse_nk</a>(E_iTrans*f2_x, i_parent-&gt;TS_frag2_kn_ratio, bond_angle_distribution[i].f2_n_imp, bond_angle_distribution[i].f2_k_imp, bond_angle_distribution[i].f2_E_nk_imp);</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                <span class="keywordflow">if</span> (i_input_data-&gt;output_to_file) fprintf(out_file.fp, <span class="stringliteral">&quot;%lf, %lf, 2, %u, %u, %lf\n&quot;</span>,</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                                                          bond_angle_distribution[i].f2_radians, bond_angle_distribution[i].probability,</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                                                          bond_angle_distribution[i].f2_n_imp, bond_angle_distribution[i].f2_k_imp, bond_angle_distribution[i].f2_E_nk_imp);</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            }</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            <span class="comment">//if (i_input_data-&gt;E_total &lt; E_potential) persistent_output&lt;&lt;i_input_data-&gt;E_total&lt;&lt;&quot;, &quot;&lt;&lt;E_recoil&lt;&lt;&quot;, &quot;&lt;&lt;E_iTrans&lt;&lt;&quot;, &quot;&lt;&lt;tunneling_probability&lt;&lt;&quot;, &quot;&lt;&lt;i_parent-&gt;initial_velocity&lt;&lt;endl;</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            <span class="comment">//persistent_output&lt;&lt;&quot; f1_n_imp=&quot;&lt;&lt;bond_angle_distribution[i].f1_n_imp&lt;&lt;&quot; f1_k_imp=&quot;&lt;&lt;bond_angle_distribution[i].f1_k_imp&lt;&lt;&quot; f1_E_nk_imp=&quot;&lt;&lt;bond_angle_distribution[i].f1_E_nk_imp;</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            <span class="comment">//persistent_output&lt;&lt;&quot; f2_n_imp=&quot;&lt;&lt;bond_angle_distribution[i].f2_n_imp&lt;&lt;&quot; f2_k_imp=&quot;&lt;&lt;bond_angle_distribution[i].f2_k_imp&lt;&lt;&quot; f2_E_nk_imp=&quot;&lt;&lt;bond_angle_distribution[i].f2_E_nk_imp&lt;&lt;&quot; PROB=&quot;&lt;&lt;bond_angle_distribution[i].probability&lt;&lt;endl;</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        }<span class="comment">//then compress to only unique f1_nk_imp/f2_nk_imp combos to reduce calculation time</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="keywordflow">for</span> (i=0; i&lt;bond_angle_distribution.size(); i++){</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            element_found=0;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            <span class="keywordflow">for</span> (j=0; j&lt;compressed_bond_angle_distribution.size(); j++){</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                <span class="keywordflow">if</span> (bond_angle_distribution[i]==compressed_bond_angle_distribution[j]){</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                    element_found=1;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                    compressed_bond_angle_distribution[j].probability+=bond_angle_distribution[i].probability;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                }</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            }</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            <span class="keywordflow">if</span> (!element_found) compressed_bond_angle_distribution.push_back(bond_angle_distribution[i]);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        bond_angle_distribution=compressed_bond_angle_distribution;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="comment">/*persistent_output&lt;&lt;&quot;*** compressed distro ***&quot;&lt;&lt;endl;</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">        for (i=0; i&lt;bond_angle_distribution.size(); i++){</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">            persistent_output&lt;&lt;&quot; f1_n_imp=&quot;&lt;&lt;bond_angle_distribution[i].f1_n_imp&lt;&lt;&quot; f1_k_imp=&quot;&lt;&lt;bond_angle_distribution[i].f1_k_imp&lt;&lt;&quot; f1_E_nk_imp=&quot;&lt;&lt;bond_angle_distribution[i].f1_E_nk_imp;</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment">            persistent_output&lt;&lt;&quot; f2_n_imp=&quot;&lt;&lt;bond_angle_distribution[i].f2_n_imp&lt;&lt;&quot; f2_k_imp=&quot;&lt;&lt;bond_angle_distribution[i].f2_k_imp&lt;&lt;&quot; f2_E_nk_imp=&quot;&lt;&lt;bond_angle_distribution[i].f2_E_nk_imp&lt;&lt;&quot; PROB=&quot;&lt;&lt;bond_angle_distribution[i].probability&lt;&lt;endl;</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">        }*/</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    }</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;}</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="keywordtype">double</span> Impulsive_Phasespace_Core::Eckart(){</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">    The following function is based on the script Eckart.py, which is part of the CanTherm program.</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">    It was found at this URL: https://github.com/GreenGroup/CanTherm_old/blob/master/source/Eckart.py</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">    The licence for that code is reproduced below:</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">    Copyright (c) 2002-2009 William H. Green and the CanTherm Team</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">    Permission is hereby granted, free of charge, to any person obtaining a copy of</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">    this software and associated documentation files (the &quot;Software&quot;), to deal in</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">    the Software without restriction, including without limitation the rights to</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">    the Software, and to permit persons to whom the Software is furnished to do so,</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">    subject to the following conditions:</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">    The above copyright notice and this permission notice shall be included in all</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">    copies or substantial portions of the Software.</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">    FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">    COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">    IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">    CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keywordtype">double</span> a1, a2, twoPIa, twoPIb, twoPId, xi, nuStar, kappa_E, numerator, denominator;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordtype">double</span> FStar = i_parent-&gt;TS_reaction_coord_force_constant*NEWTONS_PER_METER_IN_MDYNE_PER_ANGSTROM;<span class="comment">//this is the force constant as calculated by gaussian for the TS (in mdyne/A) converted to SI units (N/m)</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    nuStar=(1/(2*PI))*sqrt(FStar/(i_parent-&gt;TS_reaction_coord_reduced_mass*KG_IN_AMU));</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    a1=2*PI*(i_parent-&gt;E_dissociation+i_parent-&gt;E_barrier)*JOULES_IN_WAVENUMBER/(PLANCKS_CONSTANT*nuStar); <span class="comment">//dimensionless energy difference between TS and reactants</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    a2=2*PI*i_parent-&gt;E_barrier*JOULES_IN_WAVENUMBER/(PLANCKS_CONSTANT*nuStar); <span class="comment">//dimensionless energy difference between TS and products</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    xi=i_input_data-&gt;E_total/(i_parent-&gt;E_dissociation+i_parent-&gt;E_barrier);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    twoPIa=2*sqrt(a1*xi)/(1/sqrt(a1)+1/sqrt(a2));</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    twoPIb=2*sqrt(abs((xi-1)*a1+a2))/(1/sqrt(a1)+1/sqrt(a2)); <span class="comment">//diff from one ref ... this is how code did ... corrected in another ref</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    twoPId=2*sqrt(abs(a1*a2-4*pow(PI,2)/16));</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="keywordflow">if</span> (twoPIa&lt;200 &amp;&amp; twoPIb&lt;200 &amp;&amp; twoPId&lt;200){ <span class="comment">//all cosh arguments are small enough to use the Eckart equation for tunneling probability</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        kappa_E = 1-(cosh(twoPIa-twoPIb)+cosh(twoPId)) / (cosh(twoPIa+twoPIb)+cosh(twoPId));</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    }<span class="keywordflow">else</span>{<span class="comment">//if at least one of the following expressions is greater than 5, we can eliminate most of the exponential terms after writing out the definition of cosh() and dividing all terms by exp(twopid)</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <span class="keywordflow">if</span> ((twoPIa-twoPIb-twoPId &gt; 10) || (twoPIb-twoPIa-twoPId &gt; 10) || (twoPIa+twoPIb-twoPId &gt; 10)){</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;            kappa_E = 1 - exp(-2*twoPIa) - exp(-2*twoPIb) - exp(-twoPIa-twoPIb+twoPId) - exp(-twoPIa-twoPIb-twoPId);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        }<span class="keywordflow">else</span>{ <span class="comment">//If all of the arguments are less than 5, then evaluate the kappa_E expression normally, except use the expanded definition - expanding the cosh argument and dividing all terms by exp(twopid)</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;            numerator = exp(twoPIa-twoPIb-twoPId)+exp(-twoPIa+twoPIb-twoPId)+1+exp(-2*twoPId);</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;            denominator = exp(twoPIa+twoPIb-twoPId)+exp(-twoPIa-twoPIb-twoPId)+1+exp(-2*twoPId);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            kappa_E = 1 - numerator/denominator;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        }</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">return</span> kappa_E;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;}</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="keywordtype">void</span> Impulsive_Phasespace_Core::run(){</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <a class="code" href="struct_double___quantum___state.html">Double_Quantum_State</a> tunneling_state;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    tunneling_state.tunneled=1;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    tunneling_state.f1.n=tunneling_state.f2.n=0;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    tunneling_state.f1.k=tunneling_state.f2.k=0;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    tunneling_state.f1.E_nk=tunneling_state.f2.E_nk=0;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keywordflow">if</span> (input_data-&gt;E_available&gt;0){ <span class="comment">//if there is energy available for statistical distribution</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        count_states();</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="keywordflow">if</span> (i_input_data-&gt;output_to_file) write_result(out_file.fp);</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (tunneling_probability){ <span class="comment">//only tunneling states, which are fully impulsive</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        tunneling_state.degeneracy=i_frag1-&gt;get_degeneracy(0,0,0)+i_frag2-&gt;get_degeneracy(0,0,0);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        process_state(tunneling_state);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    }</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;}</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordtype">void</span> Impulsive_Phasespace_Core::apply_impulse(<span class="keyword">const</span> <a class="code" href="struct_double___quantum___state.html">Double_Quantum_State</a> &amp;state, <a class="code" href="struct_double___quantum___state.html">Double_Quantum_State</a> &amp;state_with_impulse, <span class="keywordtype">double</span> &amp;E_wrongBy, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> &amp;i){</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        state_with_impulse=state;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        E_wrongBy=0;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keywordflow">if</span> (i_input_data-&gt;impulsive_J_mode==0){ <span class="comment">// the old add vectors end to end version ... I think this will be removed eventually as it&#39;s probably the wrongest way</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            <span class="keywordflow">if</span> (!i_frag1-&gt;single_atom){</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                state_with_impulse.f1.n+=bond_angle_distribution[i].f1_n_imp;<span class="comment">//add the impulsive angular momentum</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                state_with_impulse.f1.k+=bond_angle_distribution[i].f1_k_imp;<span class="comment">//add the impulsive angular momentum component on principal axis</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                state_with_impulse.f1.E_nk=i_frag1-&gt;<a class="code" href="class_phasespace___molecule.html#af0646f94d520e591903b8b9a91208366">get_E_nk</a>(state_with_impulse.f1.n, state_with_impulse.f1.k);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                E_wrongBy+=state_with_impulse.f1.E_nk-state.f1.E_nk-bond_angle_distribution[i].f1_E_nk_imp; <span class="comment">//calculate the energy difference between the impulsive and PST angular momentum seperately and together (for correction below to conserve energy</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            }</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;            <span class="keywordflow">if</span> (!i_frag2-&gt;single_atom){</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                state_with_impulse.f2.n+=bond_angle_distribution[i].f2_n_imp;<span class="comment">//add the impulsive angular momentum</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                state_with_impulse.f2.k+=bond_angle_distribution[i].f2_k_imp;<span class="comment">//add the impulsive angular momentum component on principal axis</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                state_with_impulse.f2.E_nk=i_frag2-&gt;<a class="code" href="class_phasespace___molecule.html#af0646f94d520e591903b8b9a91208366">get_E_nk</a>(state_with_impulse.f2.n, state_with_impulse.f2.k);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                E_wrongBy+=state_with_impulse.f2.E_nk-state.f2.E_nk-bond_angle_distribution[i].f2_E_nk_imp;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            }</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            state_with_impulse.E_translation+=(E_recoil-bond_angle_distribution[i].f1_E_nk_imp-bond_angle_distribution[i].f2_E_nk_imp-E_wrongBy);</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (i_input_data-&gt;impulsive_J_mode==1){ <span class="comment">// add in quadrature (default) ... other option, distribution of angles over 180 degrees, will require a loop so the calling function will have to implement the if statement</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            <span class="keywordflow">if</span> (!i_frag1-&gt;single_atom){ <span class="comment">//another option would be to add the impulsive energy to each state here (IE find the correct NK state here then add, I think that&#39;s probably to go!)</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                state_with_impulse.f1.n=sqrt(pow(state.f1.n, 2) + pow(bond_angle_distribution[i].f1_n_imp, 2));<span class="comment">//add the impulsive angular momentum</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                state_with_impulse.f1.k=sqrt(pow(state.f1.k, 2) + pow(bond_angle_distribution[i].f1_k_imp, 2));<span class="comment">//add the impulsive angular momentum component on principal axis</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                state_with_impulse.f1.E_nk=i_frag1-&gt;<a class="code" href="class_phasespace___molecule.html#af0646f94d520e591903b8b9a91208366">get_E_nk</a>(state_with_impulse.f1.n, state_with_impulse.f1.k);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                E_wrongBy+=state_with_impulse.f1.E_nk-state.f1.E_nk-bond_angle_distribution[i].f1_E_nk_imp; <span class="comment">//calculate the energy difference between the impulsive and PST angular momentum seperately and together (for correction below to conserve energy</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;            }</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            <span class="keywordflow">if</span> (!i_frag2-&gt;single_atom){</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                state_with_impulse.f2.n=(unsigned)sqrt(pow(state.f2.n, 2) + pow(bond_angle_distribution[i].f2_n_imp, 2));<span class="comment">//add the impulsive angular momentum</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                state_with_impulse.f2.k=(unsigned)sqrt(pow(state.f2.k, 2) + pow(bond_angle_distribution[i].f2_k_imp, 2));<span class="comment">//add the impulsive angular momentum component on principal axis</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                state_with_impulse.f2.E_nk=i_frag2-&gt;<a class="code" href="class_phasespace___molecule.html#af0646f94d520e591903b8b9a91208366">get_E_nk</a>(state_with_impulse.f2.n, state_with_impulse.f2.k);</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                E_wrongBy+=state_with_impulse.f2.E_nk-state.f2.E_nk-bond_angle_distribution[i].f2_E_nk_imp;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;            }</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            state_with_impulse.E_translation+=(E_recoil-bond_angle_distribution[i].f1_E_nk_imp-bond_angle_distribution[i].f2_E_nk_imp-E_wrongBy);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        }</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;}</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordtype">void</span> Impulsive_Phasespace_Core::process_state(<span class="keyword">const</span> <a class="code" href="struct_double___quantum___state.html">Double_Quantum_State</a> &amp;state){</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <a class="code" href="struct_double___quantum___state.html">Double_Quantum_State</a> state_with_impulse;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <a class="code" href="struct_processed___state___data.html">Processed_State_Data</a> state_data;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="keywordtype">double</span> E_wrongBy;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordtype">unsigned</span> i, p;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    std::vector&lt;unsigned&gt; probe_ids; <span class="comment">//store the ids of all relevant probes</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="keywordflow">for</span> (i=0; i&lt;bond_angle_distribution.size(); i++){ <span class="comment">//if not using angle distribution, this will contain a single element with eq_angle and prob=1</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        apply_impulse(state, state_with_impulse, E_wrongBy, i);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <span class="keywordflow">if</span> (E_wrongBy &lt;= state.E_translation || state.tunneled){ <span class="comment">//Energy can be conserved, this state can exist (energy correction must come from the statistical reservoir)</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            state_with_impulse.degeneracy=state.degeneracy*bond_angle_distribution[i].probability*tunneling_probability;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            output_data-&gt;data-&gt;grand_total+=state_with_impulse.degeneracy;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            probe_ids.clear();</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;            <span class="keywordflow">for</span> (p=0; p&lt;output_data-&gt;<a class="code" href="class_phasespace___result.html#a5e6eeb2d779ad1d5124e8622b32e9754">probes</a>.size(); p++){</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                <span class="keywordflow">if</span> (output_data-&gt;<a class="code" href="class_phasespace___result.html#a5e6eeb2d779ad1d5124e8622b32e9754">probes</a>[p]-&gt;state.applies(state_with_impulse)){</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                    probe_ids.push_back(p);</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                    output_data-&gt;<a class="code" href="class_phasespace___result.html#a5e6eeb2d779ad1d5124e8622b32e9754">probes</a>[p]-&gt;data-&gt;grand_total+=state_with_impulse.degeneracy;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                }</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;            <span class="keywordflow">if</span> (i_input_data-&gt;output_histograms){</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                <span class="comment">//are these generic?</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                state_data.E_trans=state.E_translation;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                state_data.vel_f1=i_frag1-&gt;get_velocity(state_with_impulse.E_translation);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                state_data.vel_f2=i_frag2-&gt;get_velocity(state_with_impulse.E_translation);</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                state_data.E_trans_f1=i_frag1-&gt;get_E_trans(state_data.vel_f1);</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                state_data.E_trans_f2=i_frag2-&gt;get_E_trans(state_data.vel_f2);</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                state_data.E_vib_f1=i_frag1-&gt;vib_levels[state_with_impulse.f1.v].energy;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                state_data.E_vib_f2=i_frag2-&gt;vib_levels[state_with_impulse.f2.v].energy;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                state_data.E_int_f1=state_data.E_vib_f1+state_with_impulse.f1.E_nk+i_frag1-&gt;spin_orbit_states[state_with_impulse.f1.so].energy; <span class="comment">//E_total=E_vib+E_rot+E_soc</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                state_data.E_int_f2=state_data.E_vib_f2+state_with_impulse.f2.E_nk+i_frag2-&gt;spin_orbit_states[state_with_impulse.f2.so].energy; <span class="comment">//E_total=E_vib+E_rot+E_soc</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                increment_histograms(output_data-&gt;data, state_with_impulse, state_data);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                <span class="keywordflow">for</span> (p=0; p&lt;probe_ids.size(); p++) increment_histograms(output_data-&gt;<a class="code" href="class_phasespace___result.html#a5e6eeb2d779ad1d5124e8622b32e9754">probes</a>[probe_ids[p]]-&gt;data, state_with_impulse, state_data);</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            }</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        }</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    }</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;}</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">//***********************************************************************************************************************************************************************************</span></div>
<div class="ttc" id="class_impulsive___core___input_html"><div class="ttname"><a href="class_impulsive___core___input.html">Impulsive_Core_Input</a></div><div class="ttdef"><b>Definition:</b> impulsive_input.h:91</div></div>
<div class="ttc" id="class_impulsive___phasespace___core_html_a3ebf889009436ee732ae617225e83677"><div class="ttname"><a href="class_impulsive___phasespace___core.html#a3ebf889009436ee732ae617225e83677">Impulsive_Phasespace_Core::create_input_pointer</a></div><div class="ttdeci">virtual void create_input_pointer()</div><div class="ttdef"><b>Definition:</b> impulsive_core.h:36</div></div>
<div class="ttc" id="class_phasespace___molecule_html_af0646f94d520e591903b8b9a91208366"><div class="ttname"><a href="class_phasespace___molecule.html#af0646f94d520e591903b8b9a91208366">Phasespace_Molecule::get_E_nk</a></div><div class="ttdeci">double get_E_nk(const unsigned N, const unsigned K) const </div><div class="ttdef"><b>Definition:</b> phasespace_molecule.h:409</div></div>
<div class="ttc" id="class_impulsive___phasespace___core_html_a4ce4fe5e7ba2c7c9785b865aea84af7e"><div class="ttname"><a href="class_impulsive___phasespace___core.html#a4ce4fe5e7ba2c7c9785b865aea84af7e">Impulsive_Phasespace_Core::create_fragment_pointers</a></div><div class="ttdeci">virtual void create_fragment_pointers()</div><div class="ttdoc">in derived classes this function dynamically casts pointers to the derived version of input_data...</div><div class="ttdef"><b>Definition:</b> impulsive_core.h:40</div></div>
<div class="ttc" id="class_impulsive___molecule_html"><div class="ttname"><a href="class_impulsive___molecule.html">Impulsive_Molecule</a></div><div class="ttdef"><b>Definition:</b> impulsive_molecule.h:2</div></div>
<div class="ttc" id="struct_double___quantum___state_html"><div class="ttname"><a href="struct_double___quantum___state.html">Double_Quantum_State</a></div><div class="ttdef"><b>Definition:</b> phasespace_probe.h:7</div></div>
<div class="ttc" id="class_impulsive___phasespace___core_html_a27da2cd40c7a33e15bdca0caa8bddbf7"><div class="ttname"><a href="class_impulsive___phasespace___core.html#a27da2cd40c7a33e15bdca0caa8bddbf7">Impulsive_Phasespace_Core::initialise</a></div><div class="ttdeci">virtual void initialise()</div><div class="ttdoc">in derived classes this function dynamically casts pointers to the derived version of parent...</div><div class="ttdef"><b>Definition:</b> impulsive_core.h:46</div></div>
<div class="ttc" id="struct_processed___state___data_html"><div class="ttname"><a href="struct_processed___state___data.html">Processed_State_Data</a></div><div class="ttdef"><b>Definition:</b> phasespace_probe.h:15</div></div>
<div class="ttc" id="class_impulsive___bond___angle___distribution___element_html"><div class="ttname"><a href="class_impulsive___bond___angle___distribution___element.html">Impulsive_Bond_Angle_Distribution_Element</a></div><div class="ttdef"><b>Definition:</b> impulsive_input.h:69</div></div>
<div class="ttc" id="class_impulsive___molecule_html_aac407e174c14432636ced91f96051ad7"><div class="ttname"><a href="class_impulsive___molecule.html#aac407e174c14432636ced91f96051ad7">Impulsive_Molecule::get_impulse_nk</a></div><div class="ttdeci">void get_impulse_nk(const double &amp;E_iRot, const double &amp;kn_ratio, unsigned &amp;i_n, unsigned &amp;i_k, double &amp;i_E_nk) const </div><div class="ttdef"><b>Definition:</b> impulsive_molecule.h:177</div></div>
<div class="ttc" id="class_phasespace___core_html_a2f0204f1c0441f1b874c28df78462f66"><div class="ttname"><a href="class_phasespace___core.html#a2f0204f1c0441f1b874c28df78462f66">Phasespace_Core::parent</a></div><div class="ttdeci">const Phasespace_Molecule * parent</div><div class="ttdoc">will hold the passed Phasespace_Core_Input ... which will be cloned </div><div class="ttdef"><b>Definition:</b> phasespace_core.h:13</div></div>
<div class="ttc" id="class_phasespace___core_html"><div class="ttname"><a href="class_phasespace___core.html">Phasespace_Core</a></div><div class="ttdef"><b>Definition:</b> phasespace_core.h:3</div></div>
<div class="ttc" id="class_phasespace___result_html"><div class="ttname"><a href="class_phasespace___result.html">Phasespace_Result</a></div><div class="ttdef"><b>Definition:</b> phasespace_result.h:2</div></div>
<div class="ttc" id="class_phasespace___core_html_ab892790f7c9d9584f388ddd85df21489"><div class="ttname"><a href="class_phasespace___core.html#ab892790f7c9d9584f388ddd85df21489">Phasespace_Core::initialise</a></div><div class="ttdeci">virtual void initialise()</div><div class="ttdoc">in derived classes this function dynamically casts pointers to the derived version of parent...</div><div class="ttdef"><b>Definition:</b> phasespace_core.h:55</div></div>
<div class="ttc" id="class_phasespace___result_html_a5e6eeb2d779ad1d5124e8622b32e9754"><div class="ttname"><a href="class_phasespace___result.html#a5e6eeb2d779ad1d5124e8622b32e9754">Phasespace_Result::probes</a></div><div class="ttdeci">std::vector&lt; Phasespace_Probe * &gt; probes</div><div class="ttdoc">THIS WILL NEED TO BE A POINTER SO THAT DERIVED VERSIONS CAN BE USED IN Phasespace_Result DERIVATIVES ...</div><div class="ttdef"><b>Definition:</b> phasespace_result.h:6</div></div>
<div class="ttc" id="class_impulsive___phasespace___core_html"><div class="ttname"><a href="class_impulsive___phasespace___core.html">Impulsive_Phasespace_Core</a></div><div class="ttdef"><b>Definition:</b> impulsive_core.h:5</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Mar 30 2015 15:46:03 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.9.1
</small></address>
</body>
</html>
